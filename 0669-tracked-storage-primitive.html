<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0669-tracked-storage-primitive - </title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="affix"><a href="introduction.html">Introduction</a></li><li><a href="0001-transform-attribute-meta-parameter.html">0001-transform-attribute-meta-parameter</a></li><li><a href="0003-block-params.html">0003-block-params</a></li><li><a href="0003-cli-ember-doctor.html">0003-cli-ember-doctor</a></li><li><a href="0010-engines.html">0010-engines</a></li><li><a href="0011-improved-cp-syntax.html">0011-improved-cp-syntax</a></li><li><a href="0012-help-json-output.html">0012-help-json-output</a></li><li><a href="0015-the-road-to-ember-2-0.html">0015-the-road-to-ember-2-0</a></li><li><a href="0020-sri-default.html">0020-sri-default</a></li><li><a href="0023-command-line-completion.html">0023-command-line-completion</a></li><li><a href="0024-bound-attributes.html">0024-bound-attributes</a></li><li><a href="0028-app-import-output-file.html">0028-app-import-output-file</a></li><li><a href="0029-addon-black-and-whitelist-for-apps.html">0029-addon-black-and-whitelist-for-apps</a></li><li><a href="0045-internet-explorer.html">0045-internet-explorer</a></li><li><a href="0046-cli-improved-release-process.html">0046-cli-improved-release-process</a></li><li><a href="0046-registry-reform.html">0046-registry-reform</a></li><li><a href="0050-cli-production-code-stripping.html">0050-cli-production-code-stripping</a></li><li><a href="0050-improved-actions.html">0050-improved-actions</a></li><li><a href="0053-helpers.html">0053-helpers</a></li><li><a href="0055-anonymous-amd.html">0055-anonymous-amd</a></li><li><a href="0056-improved-release-cycle.html">0056-improved-release-cycle</a></li><li><a href="0057-ember-data-reference-unification.html">0057-ember-data-reference-unification</a></li><li><a href="0058-helper-listing.html">0058-helper-listing</a></li><li><a href="0061-ember-data-background-fetch.html">0061-ember-data-background-fetch</a></li><li><a href="0064-contextual-component-lookup.html">0064-contextual-component-lookup</a></li><li><a href="0065-deprecation-warning-handlers.html">0065-deprecation-warning-handlers</a></li><li><a href="0080-serve-file-api.html">0080-serve-file-api</a></li><li><a href="0086-firefox-in-ci.html">0086-firefox-in-ci</a></li><li><a href="0090-addon-tree-caching.html">0090-addon-tree-caching</a></li><li><a href="0091-cli-addon-instrumentation-experimental-hooks.html">0091-cli-addon-instrumentation-experimental-hooks</a></li><li><a href="0091-weakmap.html">0091-weakmap</a></li><li><a href="0092-blueprint-remove-old-files.html">0092-blueprint-remove-old-files</a></li><li><a href="0095-cli-standardise-targets.html">0095-cli-standardise-targets</a></li><li><a href="0095-router-service.html">0095-router-service</a></li><li><a href="0096-enable-yarn-usage.html">0096-enable-yarn-usage</a></li><li><a href="0101-ember-data-friendly-errors.html">0101-ember-data-friendly-errors</a></li><li><a href="0105-addons-optionalDependencies.html">0105-addons-optionalDependencies</a></li><li><a href="0108-add-custom-transform.html">0108-add-custom-transform</a></li><li><a href="0110-packaging.html">0110-packaging</a></li><li><a href="0114-add-template-lint-addon.html">0114-add-template-lint-addon</a></li><li><a href="0116-qunit-dom.html">0116-qunit-dom</a></li><li><a href="0120-cli-guides.html">0120-cli-guides</a></li><li><a href="0120-route-serializers.html">0120-route-serializers</a></li><li><a href="0121-remove-ember-cli-eslint.html">0121-remove-ember-cli-eslint</a></li><li><a href="0136-contains-to-includes.html">0136-contains-to-includes</a></li><li><a href="0139-isHtmlSafe.html">0139-isHtmlSafe</a></li><li><a href="0143-module-unification.html">0143-module-unification</a></li><li><a href="0150-factory-for.html">0150-factory-for</a></li><li><a href="0176-javascript-module-api.html">0176-javascript-module-api</a></li><li><a href="0178-deprecate-ember-k.html">0178-deprecate-ember-k</a></li><li><a href="0181-deprecate-ember-data-initializers.html">0181-deprecate-ember-data-initializers</a></li><li><a href="0186-track-unique-history-location-state.html">0186-track-unique-history-location-state</a></li><li><a href="0191-deprecate-component-lifecycle-hook-args.html">0191-deprecate-component-lifecycle-hook-args</a></li><li><a href="0194-deprecate-custom-event-manager.html">0194-deprecate-custom-event-manager</a></li><li><a href="0213-custom-components.html">0213-custom-components</a></li><li><a href="0225-ember-engines-mount-params.html">0225-ember-engines-mount-params</a></li><li><a href="0226-named-blocks.html">0226-named-blocks</a></li><li><a href="0229-deprecate-testing-restricted-resolver.html">0229-deprecate-testing-restricted-resolver</a></li><li><a href="0232-simplify-qunit-testing-api.html">0232-simplify-qunit-testing-api</a></li><li><a href="0236-deprecation-ember-string.html">0236-deprecation-ember-string</a></li><li><a href="0237-deprecation-ember-map.html">0237-deprecation-ember-map</a></li><li><a href="0240-es-classes.html">0240-es-classes</a></li><li><a href="0252-browser-support-changes.html">0252-browser-support-changes</a></li><li><a href="0268-acceptance-testing-refactor.html">0268-acceptance-testing-refactor</a></li><li><a href="0272-deprecation-native-function-prototype-extensions.html">0272-deprecation-native-function-prototype-extensions</a></li><li><a href="0276-named-args.html">0276-named-args</a></li><li><a href="0278-template-only-components.html">0278-template-only-components</a></li><li><a href="0280-remove-application-wrapper.html">0280-remove-application-wrapper</a></li><li><a href="0281-es5-getters.html">0281-es5-getters</a></li><li><a href="0286-block-let-template-helper.html">0286-block-let-template-helper</a></li><li><a href="0287-promote-in-element-to-public-api.html">0287-promote-in-element-to-public-api</a></li><li><a href="0293-record-data.html">0293-record-data</a></li><li><a href="0294-optional-jquery.html">0294-optional-jquery</a></li><li><a href="0297-deprecate-ember-logger.html">0297-deprecate-ember-logger</a></li><li><a href="0300-rfc-process-update.html">0300-rfc-process-update</a></li><li><a href="0308-deprecate-property-lookup-fallback.html">0308-deprecate-property-lookup-fallback</a></li><li><a href="0311-angle-bracket-invocation.html">0311-angle-bracket-invocation</a></li><li><a href="0318-array-helper.html">0318-array-helper</a></li><li><a href="0322-deprecate-copy-copyable.html">0322-deprecate-copy-copyable</a></li><li><a href="0324-deprecate-component-isvisible.html">0324-deprecate-component-isvisible</a></li><li><a href="0326-ember-data-filter-deprecation.html">0326-ember-data-filter-deprecation</a></li><li><a href="0329-deprecated-ember-evented-in-ember-data.html">0329-deprecated-ember-evented-in-ember-data</a></li><li><a href="0331-deprecate-globals-resolver.html">0331-deprecate-globals-resolver</a></li><li><a href="0332-ember-data-record-links-and-meta.html">0332-ember-data-record-links-and-meta</a></li><li><a href="0335-deprecate-send-action.html">0335-deprecate-send-action</a></li><li><a href="0337-native-class-constructor-update.html">0337-native-class-constructor-update</a></li><li><a href="0340-deprecate-ember-merge.html">0340-deprecate-ember-merge</a></li><li><a href="0345-discord.html">0345-discord</a></li><li><a href="0364-roadmap-2018.html">0364-roadmap-2018</a></li><li><a href="0369-deprecate-computed-clobberability.html">0369-deprecate-computed-clobberability</a></li><li><a href="0370-deprecate-computed-volatile.html">0370-deprecate-computed-volatile</a></li><li><a href="0372-ember-data-model-factory-for.html">0372-ember-data-model-factory-for</a></li><li><a href="0373-Element-Modifier-Managers.html">0373-Element-Modifier-Managers</a></li><li><a href="0375-deprecate-computed-property-modifier.html">0375-deprecate-computed-property-modifier</a></li><li><a href="0386-remove-jquery.html">0386-remove-jquery</a></li><li><a href="0389-dynamic-tag-names.html">0389-dynamic-tag-names</a></li><li><a href="0391-router-helpers.html">0391-router-helpers</a></li><li><a href="0392-deprecate-component-manager-string-lookup.html">0392-deprecate-component-manager-string-lookup</a></li><li><a href="0395-ember-data-packages.html">0395-ember-data-packages</a></li><li><a href="0398-RouteInfo-Metadata.html">0398-RouteInfo-Metadata</a></li><li><a href="0403-ember-data-identifiers.html">0403-ember-data-identifiers</a></li><li><a href="0408-decorators.html">0408-decorators</a></li><li><a href="0410-tracked-properties.html">0410-tracked-properties</a></li><li><a href="0415-render-element-modifiers.html">0415-render-element-modifiers</a></li><li><a href="0416-glimmer-components.html">0416-glimmer-components</a></li><li><a href="0418-deprecate-route-render-methods.html">0418-deprecate-route-render-methods</a></li><li><a href="0421-deprecate-application-controller-props.html">0421-deprecate-application-controller-props</a></li><li><a href="0425-website-redesign.html">0425-website-redesign</a></li><li><a href="0431-guides-restructure.html">0431-guides-restructure</a></li><li><a href="0432-contextual-helpers.html">0432-contextual-helpers</a></li><li><a href="0435-modifier-splattributes.html">0435-modifier-splattributes</a></li><li><a href="0440-decorator-support.html">0440-decorator-support</a></li><li><a href="0445-deprecate-with.html">0445-deprecate-with</a></li><li><a href="0446-contribution-guides.html">0446-contribution-guides</a></li><li><a href="0449-deprecate-partials.html">0449-deprecate-partials</a></li><li><a href="0451-injection-parameter-normalization.html">0451-injection-parameter-normalization</a></li><li><a href="0452-ember-data-medium-term-plan.html">0452-ember-data-medium-term-plan</a></li><li><a href="0457-nested-lookups.html">0457-nested-lookups</a></li><li><a href="0459-angle-bracket-built-in-components.html">0459-angle-bracket-built-in-components</a></li><li><a href="0460-yieldable-named-blocks.html">0460-yieldable-named-blocks</a></li><li><a href="0461-ember-data-singleton-record-data.html">0461-ember-data-singleton-record-data</a></li><li><a href="0463-record-data-state.html">0463-record-data-state</a></li><li><a href="0465-record-data-errors.html">0465-record-data-errors</a></li><li><a href="0466-request-state-service.html">0466-request-state-service</a></li><li><a href="0468-classic-decorator.html">0468-classic-decorator</a></li><li><a href="0470-fn-helper.html">0470-fn-helper</a></li><li><a href="0471-on-modifier.html">0471-on-modifier</a></li><li><a href="0477-blueprints-update.html">0477-blueprints-update</a></li><li><a href="0478-tracked-properties-updates.html">0478-tracked-properties-updates</a></li><li><a href="0481-component-templates-co-location.html">0481-component-templates-co-location</a></li><li><a href="0486-deprecate-mouseenter.html">0486-deprecate-mouseenter</a></li><li><a href="0487-custom-model-classes.html">0487-custom-model-classes</a></li><li><a href="0491-deprecate-disconnect-outlet.html">0491-deprecate-disconnect-outlet</a></li><li><a href="0494-async-observers.html">0494-async-observers</a></li><li><a href="0496-handlebars-strict-mode.html">0496-handlebars-strict-mode</a></li><li><a href="0507-embroider-v2-package-format.html">0507-embroider-v2-package-format</a></li><li><a href="0519-2019-2020-roadmap.html">0519-2019-2020-roadmap</a></li><li><a href="0521-find-by-identifier.html">0521-find-by-identifier</a></li><li><a href="0522-default-serializers-and-adapters.html">0522-default-serializers-and-adapters</a></li><li><a href="0523-model-argument-for-route-templates.html">0523-model-argument-for-route-templates</a></li><li><a href="0554-deprecate-getwithdefault.html">0554-deprecate-getwithdefault</a></li><li><a href="0558-edition-detection.html">0558-edition-detection</a></li><li><a href="0560-add-equality-operators.html">0560-add-equality-operators</a></li><li><a href="0561-add-numeric-comparison-operators.html">0561-add-numeric-comparison-operators</a></li><li><a href="0562-add-logical-operators.html">0562-add-logical-operators</a></li><li><a href="0580-destroyables.html">0580-destroyables</a></li><li><a href="0581-new-test-waiters.html">0581-new-test-waiters</a></li><li><a href="0585-improved-ember-registry-apis.html">0585-improved-ember-registry-apis</a></li><li><a href="0615-autotracking-memoization.html">0615-autotracking-memoization</a></li><li><a href="0617-rfc-stages.html">0617-rfc-stages</a></li><li><a href="0625-helper-managers.html">0625-helper-managers</a></li><li><a href="0626-invoke-helper.html">0626-invoke-helper</a></li><li><a href="0628-prettier.html">0628-prettier</a></li><li><a href="0631-refresh-method-for-router-service.html">0631-refresh-method-for-router-service</a></li><li><a href="0635-ember-new-lang.html">0635-ember-new-lang</a></li><li><a href="0637-customizable-test-setups.html">0637-customizable-test-setups</a></li><li><a href="0638-interactive-app-creation.html">0638-interactive-app-creation</a></li><li><a href="0639-replace-blacklist-whitelist.html">0639-replace-blacklist-whitelist</a></li><li><a href="0645-add-ember-page-title-addon.html">0645-add-ember-page-title-addon</a></li><li><a href="0649-deprecation-staging.html">0649-deprecation-staging</a></li><li><a href="0659-unique-id-helper.html">0659-unique-id-helper</a></li><li><a href="0669-tracked-storage-primitive.html" class="active">0669-tracked-storage-primitive</a></li><li><a href="0671-modernize-built-in-components-1.html">0671-modernize-built-in-components-1</a></li><li><a href="0673-deprecate-tryinvoke.html">0673-deprecate-tryinvoke</a></li><li><a href="0674-deprecate-transition-methods-of-controller-and-route.html">0674-deprecate-transition-methods-of-controller-and-route</a></li><li><a href="0680-implicit-injection-deprecation.html">0680-implicit-injection-deprecation</a></li><li><a href="0685-new-browser-support-policy.html">0685-new-browser-support-policy</a></li><li><a href="0686-deprecate-old-manager-capabilities-versions.html">0686-deprecate-old-manager-capabilities-versions</a></li><li><a href="0689-deprecate-has-block.html">0689-deprecate-has-block</a></li><li><a href="0690-deprecate-attrs-in-templates.html">0690-deprecate-attrs-in-templates</a></li><li><a href="0691-deprecate-class-binding-and-class-name-bindings.html">0691-deprecate-class-binding-and-class-name-bindings</a></li><li><a href="0692-deprecate-array-observers.html">0692-deprecate-array-observers</a></li><li><a href="0698-deprecate-link-to-positional-arguments.html">0698-deprecate-link-to-positional-arguments</a></li><li><a href="0704-deprecate-octane-optional-features.html">0704-deprecate-octane-optional-features</a></li><li><a href="0705-deprecate-jquery-optional-feature.html">0705-deprecate-jquery-optional-feature</a></li><li><a href="0706-deprecate-ember-global.html">0706-deprecate-ember-global</a></li><li><a href="0707-modernize-built-in-components-2.html">0707-modernize-built-in-components-2</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"></h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <hr />
<h2>Stage: Accepted
Start Date: 2020-09-26
Release Date: Unreleased
Release Versions:
ember-source: vX.Y.Z
ember-data: vX.Y.Z
Relevant Team(s): Ember.js
RFC PR: https://github.com/emberjs/rfcs/pull/669</h2>
<h1><a class="header" href="#tracked-storage-primitives" id="tracked-storage-primitives">Tracked Storage Primitives</a></h1>
<h2><a class="header" href="#summary" id="summary">Summary</a></h2>
<p>Provide a low level primitive for storing tracked values:</p>
<pre><code class="language-js">let storage = createStorage();

// Set the value of the storage
setValue(storage, 123);

// Get the value of the storage
getValue(storage);
</code></pre>
<h2><a class="header" href="#motivation" id="motivation">Motivation</a></h2>
<p>Today, there are two methods for creating a tracked value in Ember apps:</p>
<ol>
<li>The <code>@tracked</code> decorator, which turns class properties into tracked
properties</li>
<li><code>Ember.get</code>, which can be used to track a key on an object so that it updates
if it is set with <code>Ember.set</code>, or dirtied with <code>notifyPropertyChange</code>.</li>
</ol>
<p>The <code>@tracked</code> decorator is good for cases where there are a known set of
mutable values on a class, which is one of the most common use cases in Ember
applications. There are a number of cases, however, where there are unknown,
dynamic, or potentially infinite numbers of decoratable keys. An example of this
is <em>maps</em>.</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map">Maps</a>
are used as key-value stores, typically in cases where the keys are not known
upfront or are dynamic. In many cases, there are many thousands of potential
keys that could be used in a map, even if only a few ever actually are used.
Decorating each and every potential key on a class in these types of cases is
not practical, and if non-alpha-numeric keys are used, not possible.</p>
<p>There are a few different ways that this type of use case can be solved with
public APIs today:</p>
<ol>
<li>
<p>We can use the &quot;immutable pattern&quot;, where the map is duplicated whenever we
wish to change it, the change is applied, and the result is re-assigned to
the tracked property the map is assigned to.</p>
<pre><code class="language-js">@tracked map = new Map();

updateMapValue(key, value) {
  let newMap = new Map(this.map);
  newMap.set(key, value);
  this.map = newMap;
}
</code></pre>
<p>This pattern works nicely when followed rigorously, and was the initial
pattern proposed for <em>all</em> of these types of data structures and operations
(it's even in the official documentation). However, it is fairly unergonomic
without the aid of additional libraries, such as <a href="https://github.com/immerjs/immer">Immer.js</a>,
and it incurs a decent amount of overhead, especially in cases where the data
structures are large.</p>
<p>One solution for that is to re-set the tracked property with the same value,
after the mutation:</p>
<pre><code class="language-js">@tracked map = new Map();

updateMapValue(key, value) {
  this.map.set(key, value);
  this.map = this.map;
}
</code></pre>
<p>This pattern is problematic however, because it's not obvious what the
purpose of re-setting the property is. A developer unfamiliar with Ember may
mistakenly believe this was an error, and remove this statement, causing
bugs. It's not a very google-able pattern either, which makes it more
difficult to learn and to teach. Finally, it's fairly easy this way for the
state to get out of sync with the rest of the system if a developer forgets
to add the extra re-set after mutating the value.</p>
<p>Over time, it's become clear that this pattern is in actuality an antipattern
for these reasons, and something we should begin to discourage in general.</p>
<p>Note that the <em>original</em> immutable pattern, in which state is fully copied,
does not have these problems, and remains a fully valid pattern. However, due
to performance constraints, ergonomics, and personal preferences, it does not
make sense for <em>every</em> Ember application, so we still need to enable
alternative patterns.</p>
</li>
<li>
<p>We can continue to use <code>Ember.get</code> and <code>Ember.set</code> with plain objects.
This pattern works now and will continue to work for the forseeable future,
but does not support using non-string values as keys, so it cannot cover all
the same use cases as Map. In addition, it's not practical for other types of
collections, such as as arrays, since <code>get</code> and <code>set</code> were not built to work
with them.</p>
<p>In addition, it presents a mismatch between the models put forward in Octane,
and the models of Ember classic. In Octane, the idea is that the details of
state tracking are <em>opaque</em> to the user. Using <code>get</code> and <code>set</code> manually means
that every time the object is accessed or updated, the user has to
consciously remember to use these special functions - they have to <em>think</em>
about the details of tracking state. This is a bug-prone process, because it
only takes one mistake in one usage, and the state itself could be used in
many places. In Octane, users should only need to declare reactivity once -
when the state itself is defined.</p>
</li>
<li>
<p>We can use the Cell pattern, as described in <a href="https://www.pzuraq.com/autotracking-case-study-trackedmap/">this blog post</a>.
This pattern is robust, and can be used to make many types of tracked data
structures, as the <a href="https://github.com/pzuraq/tracked-built-ins">tracked-built-ins</a>
library shows. There are a few main downsides to it:</p>
<ul>
<li>Since it is not a formalized pattern, anyone who wants to use it has to
reimplement it. This is not a huge amount of code to add to any given
addon, but it means addon authors have to rederive the pattern themselves
from scratch, which is not ideal. It means there is more overhead overall
to learning these patterns in the first place.</li>
<li>It is not an optimal pattern, because it adds a layer of decoration and an
instance of a class for every cell. This is not a major amount of overhead,
but ideally we wouldn't incur it at all.</li>
<li>It has no potential for future extensibility, particularly with regards to
<em>debug</em> tooling. Ideally, tracked state, even custom tracked state, should
be easy to understand and debug with standard Ember tooling. Currently,
when users look at a stack trace with an issue caused by a cell, they get
something that is very difficult to understand (&quot;why is it telling me
there's an issue with setting <code>value</code> when I'm setting a completely
different key on my TrackedMap?&quot;)</li>
</ul>
</li>
</ol>
<p>Out of these patterns, the Cell pattern is the most robust and most in-line with
state management in Ember Octane. This RFC seeks to formalize it and add it to
the framework, so we can standardize on a common pattern and address the issues
that it currently has.</p>
<h2><a class="header" href="#detailed-design" id="detailed-design">Detailed design</a></h2>
<p>This RFC proposes adding the following APIs, exported from
<code>@glimmer/tracking/primitives/storage</code>:</p>
<pre><code class="language-ts">declare function createStorage&lt;T&gt;(
  initialValue?: T,
  isEqual?: (oldValue: T, newValue: T) =&gt; boolean
): Storage&lt;T&gt;;

declare function getValue&lt;T&gt;(storage: Storage&lt;T&gt;): T;

declare function setValue&lt;T&gt;(storage: Storage&lt;T&gt;, value: T): void;
</code></pre>
<h3><a class="header" href="#createstorage" id="createstorage"><code>createStorage</code></a></h3>
<p>This function creates and returns an instance of a tracked storage. Tracked
storage instances contain one value, which can be read with <code>getValue</code> and set
with <code>setValue</code>. Reading the value consumes it, so that any tracked computations
which are currently active will become entangled with it, and setting value
later will dirty it and cause them to recompute. Creating the value does <em>not</em>
consume it.</p>
<p><code>createStorage</code> can receive an optional initial value as its first parameter.
It also receives an optional <code>isEqual</code> function. This function runs whenever the
value is about to be set, and determines if the value is equal to the previous
value. If it is equal, it does not set the value or dirty it. This defaults to
<code>===</code> equality.</p>
<h3><a class="header" href="#getvalue" id="getvalue"><code>getValue</code></a></h3>
<p>This function receives a tracked storage instance, and returns the value it
contains, consuming it so that it entangles with any currently active
autotracking contexts.</p>
<h3><a class="header" href="#setvalue" id="setvalue"><code>setValue</code></a></h3>
<p>This function receives a tracked storage instance and a value, and sets the
value of the tracked storage to the passed value if it is not equal to the
previous value. If the value is set, it will dirty the storage, causing any
tracked computations which consumed the stored value to recompute. If the value
was <em>not</em> changed, then it does not set the value or dirty it.</p>
<h3><a class="header" href="#re-implementing-tracked-with-storage" id="re-implementing-tracked-with-storage">Re-implementing <code>@tracked</code> with storage</a></h3>
<p>We can see how the <code>@tracked</code> decorator itself can be re-implemented using
tracked storage.</p>
<pre><code class="language-js">function tracked(target, key, { initializer }) {
  let storages = new WeakMap();

  function getStorage(obj) {
    let storage = storages.get(obj);

    if (storage === undefined) {
      storage = createStorage(initializer.call(this), () =&gt; true);
      storages.set(this, storage);
    }

    return storage;
  };

  return {
    get() {
      return getValue(getStorage(this));
    },

    set(value) {
      return setValue(getStorage(this), value);
    },
  };
}
</code></pre>
<h3><a class="header" href="#a-note-on-this-design" id="a-note-on-this-design">A note on this design</a></h3>
<p>In general, API design and cohesiveness is an important value in Ember. We work
very hard as a community to develop patterns which are uniform across many
different types of APIs, which in turn leads to a better DX as developers can
generally know what to expect from a given API without even needing to read the
documentation.</p>
<p>The API proposed in this RFC, which uses functions to access and manipulate a
value via an opaque handle, is an unusual API design when compared to most other
Ember APIs. It is a pattern which provides extra flexibility to the implementers
of the API, at the cost of a <em>severe</em> DX penalty for the users of the API,
because of this unusual-ness.</p>
<p>As such this pattern should be used extremely sparingly, on APIs which meet the
following criteria:</p>
<ol>
<li>They are not expected to be used by <em>every</em> Ember developer. If the API will
be used in the Super Rentals tutorial, or the standard non-advanced sections
of the guides, then it should not use this pattern.</li>
<li>They are for extremely core parts of Ember, such as autotracking, where the
primitives underlying them could potentially change significantly in the
future, and maximum flexibility is desired because of this.</li>
<li>They are for extremely performance critical parts of Ember, with usages in
the hundreds of thousands or millions per app, and so maximum flexbility is
desired in order to be able to leverage changes to the primitives for
optimizing performance.</li>
</ol>
<p>In general, most Ember APIs will <em>not</em> meet these requirements, and so this API
design should not be used for them.</p>
<h2><a class="header" href="#how-we-teach-this" id="how-we-teach-this">How we teach this</a></h2>
<p>The API docs for this feature can be taken from the descriptions of the
functions in the detailed design section of the RFC. The following guide should
be added to the Autotracking In-Depth guide in the official guides, and the
section on <a href="https://guides.emberjs.com/release/in-depth-topics/autotracking-in-depth/#toc_plain-old-javascript-objects-pojos">POJOs</a>
should be removed.</p>
<h3><a class="header" href="#creating-custom-tracked-data-structures" id="creating-custom-tracked-data-structures">Creating custom tracked data structures</a></h3>
<p>Tracked properties are a great solution for many different use cases. However,
sometimes they aren't the right tool for the job. For instance, you may need
have a problem that requires you to work with a number of dynamically created
properties, rather than ones that you know up front.</p>
<p>For example, we could make a scoreboard component that keeps score for an
arbitrary number of players, and keep track of the score for each player using
a JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map">Map</a>.</p>
<pre><code class="language-js">// app/components/scoreboard.js
import Component from '@glimmer/component';
import { action } from '@ember/object';

export default class Scoreboard extends Component {
  // Mock data for players - this would eventually be replaced with an argument
  // so players could be passed in
  players = [
    { name: 'Zoey' },
    { name: 'Tomster' },
  ];

  // Create a map from player -&gt; score, with each player's score starting at 0
  scores = new Map(this.players.map(p =&gt; [p, 0]));

  @action
  incrementScore(player) {
    let currentScore = this.scores.get(player);

    this.scores.set(player, currentScore + 1);
  }
}
</code></pre>
<pre><code class="language-hbs">{{#each-in this.scores |player score|}}
  &lt;div&gt;
    {{player.name}}: {{score}}

    &lt;button type=&quot;button&quot; {{on &quot;click&quot; (fn this.incrementScore player)}}&gt;
      +
    &lt;/button&gt;
  &lt;/div&gt;
{{/each-in}}
</code></pre>
<p>This component will loop over the map of scores and show each player's name and
score, along with a button to increment the score. The logic for this component
is all correct, but it won't update when we increment the score because the
<code>scores</code> map is not tracked state. Let's fix that!</p>
<p>Ember provides a set of primitive APIs for creating <em>tracked storage</em>. These
APIs can be used to create higher level tracked data structures. In fact, the
<code>@tracked</code> decorator is <em>implemented</em> using tracked storage, and we can see how
it boils down to tracked storage under the hood in this example.</p>
<pre><code class="language-js">import { tracked } from '@glimmer/tracking';

class Person {
  @tracked name;
}

// could be thought of as:
import {
  createStorage,
  getValue,
  setValue
} from '@glimmer/tracking/primitives/storage';

class Person {
  #name = createStorage();

  get name() {
    return getValue(this.#name);
  }

  set name(value) {
    setValue(this.#name, value);
  }
}
</code></pre>
<p>In this case, we'll create <code>TrackedMap</code>, a class that has the same public API
and behavior as <code>Map</code>, but is integrated with autotracking so that if we read or
update a value in the map our app will correctly rerender.</p>
<p>First off, let's start off with the basics for our class. We want it to have the
same semantics as a standard map, and there's no need to re-implement the wheel.
We can use a standard map as the backing storage for our custom wrapper, and
defer to it directly.</p>
<pre><code class="language-js">// app/utils/tracked-map.js
class TrackedMap {
  #map = new Map();

  constructor(initialValues) {
    for (let [key, value] of initialValues) {
      this.set(key, value);
    }
  }

  get(key) {
    return this.#map.get(key);
  }

  set(key, value) {
    this.#map.set(key, value);
  }

  forEach(fn) {
    this.#map.forEach(fn);
  }

  // Other methods and APIs omitted...
}
</code></pre>
<p>Now, we need to add our tracked storage. We'll use the <code>createStorage</code> API to do
this.</p>
<pre><code class="language-js">// app/utils/tracked-map.js
import {
  createStorage,
  getValue,
  setValue,
} from '@glimmer/tracking/primitives/storage';

class TrackedMap {
  #map = new Map();

  constructor(initialValues) {
    for (let [key, value] of initialValues) {
      this.set(key, value);
    }
  }

  _getStorage(key) {
    let storage = this.#map.get(key);

    if (storage === undefined) {
      storage = createStorage();
      this.#map.set(key, storage);
    }

    return storage;
  }

  get(key) {
    return getValue(this._getStorage(key));
  }

  set(key, value) {
    setValue(this._getStorage(key), value);
  }

  forEach(fn) {
    this.#map.forEach((storage, key) =&gt; fn(getValue(storage, key, this)));
  }

  // Other methods and APIs omitted...
}
</code></pre>
<p>Now, instead of setting values directly in our internal private map, we're
wrapping those values in tracked storage. We create the storage instances with
<code>createStorage</code>, we get the value from them with <code>getValue</code>, and we set
the value in the with <code>setValue</code>. Each tracked storage contains exactly one
value, and whenever we read that value with <code>getValue</code>, it is consumed in any
tracked computations that are currently occuring - just like reading the value
of a tracked property. Likewise, setting the value of a tracked storage instance
with <code>setValue</code> will dirty it, and cause any tracked computations which used it
previously to recompute, just like setting the value of a tracked property.</p>
<p>There's just one issue with this implementation so far - what happens to
<code>forEach</code> if we add a <em>new</em> value to the <code>TrackedMap</code>, one that didn't exist
before? Currently, <code>forEach</code> will consume every <em>existing</em> value and entangle
it, but it will not rerun if we were to add a new key to the map.</p>
<p>Logically, the thing we're trying to represent here is the state of the
collection's iteration. We can do this by creating another storage, and placing
the collection in it.</p>
<pre><code class="language-js">// app/utils/tracked-map.js
import {
  createStorage,
  getValue,
  setValue,
} from '@glimmer/tracking/primitives/storage';

class TrackedMap {
  #map = new Map();
  #collection = createStorage(this, () =&gt; true);

  constructor(initialValues) {
    for (let [key, value] of initialValues) {
      this.set(key, value);
    }
  }

  _getStorage(key) {
    let storage = this.#map.get(key);

    if (storage === undefined) {
      storage = createStorage();
      this.#map.set(key, storage);
    }

    return storage;
  }

  get(key) {
    return getValue(this._getStorage(key));
  }

  set(key, value) {
    // dirty the collection state
    setValue(this.#collection, this);
    setValue(this._getStorage(key), value);
  }

  forEach(fn) {
    // Entangle the collection state
    getValue(this.#collection);
    this.#map.forEach((storage, key) =&gt; fn(getValue(storage, key, this)));
  }

  // Other methods and APIs omitted...
}
</code></pre>
<p>Now we have a storage that we use to represent the value of the collection
itself. We pass a custom equality function to this storage which always returns
<code>true</code>, meaning that whenever we set the value of this storage, it will <em>always</em>
notify, even if the value hasn't changed. We then entangle the collection
storage in <code>forEach</code> by using <code>getValue</code> on it, even though we don't actually
use the value, and we dirty with <code>setValue</code> whenever we <code>set</code> a value. Since we
used a custom equality function that will always notify, we can set it to the
collection itself again.</p>
<p>That should cover all of the basic functionality! If we now use <code>TrackedMap</code> in
our original example instead of <code>Map</code> everything should update and work as
expected:</p>
<pre><code class="language-js">// app/components/scoreboard.js
import Component from '@glimmer/component';
import { action } from '@ember/object';
import TrackedMap from '../utils/tracked-map';

export default class Scoreboard extends Component {
  // Mock data for players - this would eventually be replaced with an argument
  // so players could be passed in
  players = [
    { name: 'Zoey' },
    { name: 'Tomster' },
  ];

  // Create a map from player -&gt; score, with each player's score starting at 0
  scores = new TrackedMap(this.players.map(p =&gt; [p, 0]));

  @action
  incrementScore(player) {
    let currentScore = this.scores.get(player);

    this.scores.set(player, currentScore + 1);
  }
}
</code></pre>
<pre><code class="language-hbs">{{#each-in this.scores |player score|}}
  &lt;div&gt;
    {{player.name}}: {{score}}

    &lt;button type=&quot;button&quot; {{on &quot;click&quot; (fn this.incrementScore player)}}&gt;
      +
    &lt;/button&gt;
  &lt;/div&gt;
{{/each-in}}
</code></pre>
<h2><a class="header" href="#alternatives" id="alternatives">Alternatives</a></h2>
<ul>
<li>
<p>Stick with higher level APIs and don't expose the primitives. This could lead
to an explosion of high level complexity, as Ember tries to provide every type
of construct for users to use, rather than a low level primitive.</p>
</li>
<li>
<p>Expose a more functional or more object-oriented API. This would be a somewhat
higher level API than the one proposed here, which may be a bit more
ergonomic, but also would be less flexible. Since this is a new primitive and
we aren't sure what features it may need in the future, the current design
keeps the implementation open and lets us experiment without foreclosing on a
possible higher level design in the future. It also matches with the
previously added primitive APIs.</p>
</li>
</ul>
<h2><a class="header" href="#open-questions" id="open-questions">Open Questions</a></h2>
<ul>
<li>
<p>Should we add a <code>peekValue</code> API to check the value without entangling it? This
API is something we've avoided doing for some time because it's very easy to
accidentally cause bugs with it, but it's also something that is possible to
emulate today with a little extra bookkeeping. It's something that has been
asked for a few times as well.</p>
</li>
<li>
<p>Should we add some debug tooling information as the final argument to these
APIs? If so, what should that information be?</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="0659-unique-id-helper.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="0671-modernize-built-in-components-1.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="0659-unique-id-helper.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="0671-modernize-built-in-components-1.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
